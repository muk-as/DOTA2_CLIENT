"use strict";

var g_nClientPointCapMax = -1;
var g_nClientPointCapUsed = -1;
var g_nRewardLineTier1 = -1;
var g_nRewardLineTier2 = -1;
var g_nNumRewardRequests = 0;
var g_nBossEntIndex = -1;

var g_bInCryptEncounter = false;

$.GetContextPanel().SetDialogVariableInt( "battle_points", 0 );
$.GetContextPanel().SetDialogVariableInt( "arcane_fragments", 0 );
$.GetContextPanel().SetDialogVariableInt( "weekly_quest_stars", 0 );

//-----------------------------------------------------------------------------------------
function intToARGB(i) 
{ 
    return ('00' + ( i & 0xFF ).toString( 16 ) ).substr( -2 ) +
           ('00' + ( ( i >> 8 ) & 0xFF ).toString( 16 ) ).substr( -2 ) +
           ('00' + ( ( i >> 16 ) & 0xFF ).toString( 16 ) ).substr( -2 ) + 
           ('00' + ( ( i >> 24 ) & 0xFF ).toString( 16 ) ).substr( -2 );
}

//-----------------------------------------------------------------------------------------
$.Schedule( 0.0, function() 
{
	// Startup code
	UpdateGlobalUIElements( )

 	var nPlayerID = Players.GetLocalPlayer();
	if ( nPlayerID < 0 || nPlayerID > 3 || Players.IsLocalPlayerLiveSpectating() || Players.IsSpectator( nPlayerID ) )
	{
		nPlayerID = 0;
	}

	var hMinimapInfo = CustomNetTables.GetTableValue( "game_global", "minimap_info" + nPlayerID );
	if ( hMinimapInfo != null )
	{
		OnHeroChangedRoom( hMinimapInfo );
	}
} );

function OnGameGlobalChanged( table_name, key, data )
{
	if ( key == "ascension_level" )
	{
		UpdateGlobalUIElements();
		return;	
	}

	var nPlayerID = Players.GetLocalPlayer();
	if ( nPlayerID < 0 || nPlayerID > 3 || Players.IsLocalPlayerLiveSpectating() || Players.IsSpectator( nPlayerID ) )
	{
		nPlayerID = 0;
	}

	if ( key == ( "minimap_info" + nPlayerID ) )
	{
		OnHeroChangedRoom( data );
	}
}

CustomNetTables.SubscribeNetTableListener( "game_global", OnGameGlobalChanged );

//-----------------------------------------------------------------------------------------
function UpdateGlobalUIElements( )
{
	var hudPanel = $.GetContextPanel().FindAncestor( "CustomUIRoot" );
	if ( hudPanel )
	{
		hudPanel.RemoveClass( "AghanimEndGameCinematic" );
	}

    var AscensionLevel = CustomNetTables.GetTableValue( "game_global", "ascension_level" );
	var nAscensionLevel = AscensionLevel ? AscensionLevel[ "1" ] : 0;

	var hTournamentMode = CustomNetTables.GetTableValue( "game_global", "tournament_mode" );
	var nTournamentSeed = hTournamentMode ? Number( hTournamentMode["1"] ) : 0;
	if ( nTournamentSeed == 0 )
	{
		$( "#DifficultyContainer" ).SetDialogVariable( "difficulty_name", $.Localize( "#TI10_EventGame_AscensionName_" + nAscensionLevel ) );		
		$( "#DifficultyContainer").SwitchClass( "ascension_level", "AscensionLevel" + nAscensionLevel );
	}
	else
	{
		$( "#DifficultyContainer" ).SetDialogVariable( "difficulty_name", $.Localize( "#TI10_EventGame_ChallengeName_Title" ) );		
		$( "#DifficultyContainer").SwitchClass( "ascension_level", "InTournamentMode" );
	}
}

function OnHeroChangedRoom( data )
{
	//$.Msg( "OnHeroChangedRoom" );
	$( '#OverlayMap' ).fixedoffsetenabled = true
	$( '#OverlayMap' ).SetFixedOffset( data[ "x" ] , data[ "y" ] );
	$( '#OverlayMap' ).mapscale =  data[ "scale" ];
	$( '#OverlayMap' ).SetFixedBackgroundTexturePosition( data[ "size" ], data[ "x" ] , data[ "y" ] );

	var szName = "materials/overviews/" + data[ "map_name" ] + ".vtex";
	//$.Msg( "Setting map texture " + szName );
	$( '#OverlayMap' ).maptexture = szName;
}


var g_szEncounterName = null;

function OnIntroduceEncounter( data )
{
	if ( data === null )
		return;

	g_szEncounterName = data.encounter_name;

	$( "#RoomDiscoverPanel" ).FindChildInLayoutFile( "EncounterNameLabel" ).SetDialogVariable( "encounter_name", $.Localize( '#' + data.encounter_name ) );
	$( "#RoomDiscoverPanel" ).FindChildInLayoutFile( "InProgressEncounterNameLabel" ).SetDialogVariable( "encounter_name", $.Localize( '#' + data.encounter_name ) );
	$( "#RoomDiscoverPanel" ).SetHasClass( "InProgress", false );
	$( "#RoomDiscoverPanel" ).SetHasClass( "Visible", true );
	$( "#RoomDiscoverPanel" ).SetHasClass( "HardRoom", data[ "hard_room" ] == 1 );
	$( "#RoomDiscoverPanel" ).SwitchClass( "DifficultyLevel", "Difficulty"+data[ "total_difficulty" ] );
	$( "#RoomDiscoverPanel" ).SwitchClass( "EncounterName", data.encounter_name );
	$( "#RoomDiscoverPanel" ).SwitchClass( "RoomType", data.room_type );
	$( "#RoomDiscoverPanel" ).SetDialogVariable( "encounter_depth", Number( data.encounter_depth ) - 1 );
	var szRoomName = $.Localize( "#DOTA_AghsLab_TitleDepth" + ( Number( data.encounter_depth ) - 1 ).toString(), $.GetContextPanel() );
	$.Msg( szRoomName );
	$( "#RoomDiscoverPanel" ).SetDialogVariable( "room_name", szRoomName );

	var hAbilitiesContainer = $( "#RoomDiscoverPanel" ).FindChildInLayoutFile( "AscensionAbilitiesContainer" );
	var hAbilitiesContainerInProgress = $( "#RoomDiscoverPanel" ).FindChildInLayoutFile( "AscensionAbilitiesContainerInProgress" );
	hAbilitiesContainer.RemoveAndDeleteChildren(); 
	hAbilitiesContainerInProgress.RemoveAndDeleteChildren(); 
	var bHasAscensionAbilities = false;
	if ( data[ "ascension_abilities" ] != null )
	{
		for ( var key of Object.keys( data[ "ascension_abilities" ] ) )
		{
			var abilityName = data[ "ascension_abilities" ][ key ];
			if ( abilityName == null )
				continue;

			bHasAscensionAbilities = true;
			var hAbilityPanel = $.CreatePanel( "Panel", hAbilitiesContainer, abilityName );
	      	hAbilityPanel.BLoadLayoutSnippet( "AscensionAbilitySnippet" );
			hAbilityPanel.SetDialogVariable( "ability_name", $.Localize( '#' + abilityName ) );

			hAbilityPanel = $.CreatePanel( "Panel", hAbilitiesContainerInProgress, abilityName );
	      	hAbilityPanel.BLoadLayoutSnippet( "AscensionAbilitySnippet" );
			hAbilityPanel.SetDialogVariable( "ability_name", $.Localize( '#' + abilityName ) );			
		}		
	}

	$( "#RoomDiscoverPanel" ).SetHasClass( "HasAscensionAbilities", bHasAscensionAbilities );
	//Game.EmitSound( "RoomDiscover" );

	$.Schedule( 8.0, EndEncounterIntroduction );
}

function EndEncounterIntroduction()
{
	$( "#RoomDiscoverPanel" ).SetHasClass( "InProgress", true );
}

GameEvents.Subscribe( "introduce_encounter", OnIntroduceEncounter );


function OnCompleteEncounter()
{
	$( "#RoomDiscoverPanel" ).SetHasClass( "Visible", false );
	$( "#RoomDiscoverPanel" ).SetHasClass( "InProgress", false );
	$( "#RoomDiscoverPanel" ).FindChildInLayoutFile( "ObjectivesContainer" ).RemoveAndDeleteChildren(); 
}

GameEvents.Subscribe( "complete_encounter", OnCompleteEncounter );


function OnEncounterUpdated()
{
	var Depth = CustomNetTables.GetTableValue( "encounter_state", "depth" );
	var szCurrentDepth = Depth ? Depth[ "1" ] : null;
	if ( szCurrentDepth === null )
		return;

	var data = CustomNetTables.GetTableValue( "encounter_state", szCurrentDepth );
	if ( data == null )
		return;

	var ObjectivesContainer = $( "#RoomDiscoverPanel" ).FindChildTraverse( "ObjectivesContainer" );
	for ( var key of Object.keys( data[ "objectives" ] ) )
	{
		var Objective = data[ "objectives" ][ key ];
		if ( Objective == null )
			continue;

		//$.Msg( "Found an objective" );
		var ObjectivePanel = ObjectivesContainer.FindChildTraverse( Objective[ "name" ] );
		if ( ObjectivePanel === null )
		{
			var nOrder = Objective[ "order" ];
			var hBeforeChild = null;
			for ( var nChild = 0; nChild < ObjectivesContainer.GetChildCount(); nChild++ )
			{
				var hChild = ObjectivesContainer.GetChild( nChild );
				if ( hChild == null )
					continue;

				if ( hChild.GetAttributeInt( "order", 0 ) >= nOrder )
				{
					hBeforeChild = hChild;
					break;
				}
			}

			//$.Msg( "Creating new snippet" );
			ObjectivePanel = $.CreatePanel( "Panel", ObjectivesContainer, Objective[ "name" ] );
	        ObjectivePanel.BLoadLayoutSnippet( "ObjectveSnippet_GoalValue" );
	        if ( hBeforeChild != null )
	        {
	        	ObjectivesContainer.MoveChildBefore( ObjectivePanel, hBeforeChild );
	        }
	        ObjectivePanel.SetAttributeInt( "order", nOrder );
		}

		var szObjectiveLocString = Objective[ "name" ];
		ObjectivePanel.SetDialogVariable( "objective", $.Localize( '#' + szObjectiveLocString ) );

		var nValue = Objective[ "value" ];
		ObjectivePanel.SetDialogVariableInt( "value", nValue );

		var nGoal = Objective[ "goal" ];
		ObjectivePanel.SetDialogVariableInt( "goal", nGoal );

		ObjectivePanel.SetHasClass( "Simple", nGoal == 0 );
	}

	UpdateBonusRound();

	if ( data[ "encounter_name" ] == "encounter_crypt_gate" )
	{
		var cryptData = CustomNetTables.GetTableValue( "encounter_state", "crypt_gate" );
		if ( cryptData == null )
			return;

		UpdateCryptGateUI( cryptData );
	} 
}

function UpdateCryptGateUI( cryptData )
{
	var CryptUI = $( "#CryptGateUI" );
	if ( CryptUI == null )
		return;

	var flTotalProgress = cryptData[ "total_progress" ];
	var bPanelActive = flTotalProgress > 0.0 && flTotalProgress < 1.0;
	g_bInCryptEncounter = bPanelActive;
	CryptUI.SetHasClass( "CryptGateActive", bPanelActive );
	if ( !bPanelActive )
		return;

	var OverallCryptProgress = CryptUI.FindChildTraverse( "CryptGateTotalProgressBar" );
	OverallCryptProgress.value = flTotalProgress;

	var bAnyTouching = false;

	for ( var key of Object.keys( cryptData ) )
	{
		var CryptTrigger = cryptData[ key.toString()  ];
		if ( CryptTrigger == null || key.toString() == "total_progress" )
			continue;

		var vAbsOrigin = [ CryptTrigger[ "X" ], CryptTrigger[ "Y" ], CryptTrigger[ "Z" ] ];
		var nX = Game.WorldToScreenX( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
		var nY = Game.WorldToScreenY( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );

		var CryptTriggerProgressBar = CryptUI.FindChildTraverse( key );

		CryptTriggerProgressBar.style.x = ( nX / CryptTriggerProgressBar.actualuiscale_x ) - 50 + "px"; 
		CryptTriggerProgressBar.style.y = ( nY / CryptTriggerProgressBar.actualuiscale_y ) + 50 + "px"; 
		CryptTriggerProgressBar.value = CryptTrigger[ "progress" ];
		CryptTriggerProgressBar.SetHasClass( "CryptTriggerTouched", CryptTrigger[ "touched" ] );
		if ( CryptTrigger["touched"] )
		{
			bAnyTouching = true;
		}
		CryptTriggerProgressBar.SetHasClass( "CryptTriggerComplete", CryptTrigger[ "progress" ] >= 1.0 );
	}

	CryptUI.SetHasClass( "AnyTouching", bAnyTouching );	
}

CustomNetTables.SubscribeNetTableListener( "encounter_state", OnEncounterUpdated )

function OnBossUpdated( )
{
	var CurrentBoss = CustomNetTables.GetTableValue( "boss_net_table", "current_boss" );

	if( CurrentBoss )
	{
		$( "#BossHealthBarContainer").SetHasClass( "Visible", CurrentBoss.active == true && g_bInBossCamera == false );
		g_nBossEntIndex = CurrentBoss.ent_index

		$( "#BossLabel" ).text = $.Localize( GetUnitNameLocalized( CurrentBoss.unit_name ) )

		$( "#BossHealthBarContainer").SwitchClass( "class", "Boss_"+CurrentBoss.unit_name )

		if ( CurrentBoss.active )
		{
			//var flBossHP = CurrentBoss.hp;
			$( "#BossProgressBar" ).value = CurrentBoss.hp;
			//BossThink();
		}
	}
}

CustomNetTables.SubscribeNetTableListener( "boss_net_table", OnBossUpdated )

function OnBattleRoyaleDamageStarting( )
{ 
	$( "#BattleRoyaleDamageStarting" ).AddClass( "Visible" );
	$( "#BattleRoyaleDamageStarting" ).RemoveClass( "Visible" );
}

GameEvents.Subscribe( "battle_royale_damage_starting", OnBattleRoyaleDamageStarting );

function OnGainedLife( data )
{
	var heroImage = $( '#1UpHeroIcon' );
	var heroImageShadow = $( '#1UpHeroIconOutline' );
	var localPlayerInfo = Game.GetLocalPlayerInfo();
	var heroName = Players.GetPlayerSelectedHero( localPlayerInfo.player_id );
	var vAbsOrigin =  Entities.GetAbsOrigin( localPlayerInfo.player_selected_hero_entity_index );
	var panel = $( '#1UpPopup' );

	var nX = Game.WorldToScreenX( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
	var nY = Game.WorldToScreenY( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
	panel.style.x = ( nX / panel.actualuiscale_x ) - (  panel.actuallayoutwidth / 2 ) + "px"; 
	panel.style.y = ( nY / panel.actualuiscale_y  ) - 150 + "px";

	panel.SetHasClass( "Play1Up", true );
	
	heroImage.heroname = heroName;
	heroImageShadow.heroname = heroName;
	Game.EmitSound( "Dungeon.Plus1" );
	$.Schedule( 3.0, HideGainedLife );
}

GameEvents.Subscribe( "gained_life", OnGainedLife );

function HideGainedLife()
{
	var panel = $( '#1UpPopup' );
	panel.SetHasClass( "Play1Up", false );
}

function OnLostLife( data )
{
	var heroImage = $( '#1UpHeroIcon' );
	var heroImageShadow = $( '#1UpHeroIconOutline' );
	var localPlayerInfo = Game.GetLocalPlayerInfo();
	var heroName = Players.GetPlayerSelectedHero( localPlayerInfo.player_id );
	var vAbsOrigin =  Entities.GetAbsOrigin( localPlayerInfo.player_selected_hero_entity_index );
	var panel = $( '#1UpPopup' );

	var nX = Game.WorldToScreenX( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
	var nY = Game.WorldToScreenY( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
	panel.style.x = ( nX / panel.actualuiscale_x ) - (  panel.actuallayoutwidth / 2 ) + "px"; 
	panel.style.y = ( nY / panel.actualuiscale_y  ) - 150 + "px";

	panel.SetHasClass( "Play1Up", true );
	panel.SetHasClass( "LifeLost", true );
	
	heroImage.heroname = heroName;
	heroImageShadow.heroname = heroName;
	//Game.EmitSound( "Dungeon.Plus1" );
	$.Schedule( 3.0, HideLostLife );
}

GameEvents.Subscribe( "life_lost", OnLostLife );

function HideLostLife()
{
	var panel = $( '#1UpPopup' );
	panel.SetHasClass( "Play1Up", false );
	panel.SetHasClass( "LifeLost", false );
}

function OnCurrencyUpdated( )
{
	var nPlayerID = Players.GetLocalPlayer()
	var nTeam = Players.GetTeam( nPlayerID )
	if ( nTeam != DOTATeam_t.DOTA_TEAM_GOODGUYS && nTeam != DOTATeam_t.DOTA_TEAM_BADGUYS )
		return;

	var data = CustomNetTables.GetTableValue( "currency_rewards", nPlayerID.toString() );
	$( '#EarnedPointsContainer' ).SetDialogVariableInt( "battle_points", data[ "battle_points" ] );
	$( '#EarnedPointsContainer' ).SetDialogVariableInt( "arcane_fragments", data[ "arcane_fragments" ] );
	$( '#EarnedPointsContainer' ).SetDialogVariableInt( "weekly_quest_stars", data[ "weekly_quest_stars" ] );
	$( '#EarnedPointsContainer' ).SetHasClass( "WeeklyStarsVisible", data[ "weekly_quest_stars" ] > 0 );
}


CustomNetTables.SubscribeNetTableListener( "currency_rewards", OnCurrencyUpdated );

var g_bBonusActive = false;
var g_flBonusEndTime = -1;

function OnBonusStart( data )
{
	var BonusPanel = $( '#BonusPanel' );
	var PlayerIDs = Game.GetPlayerIDsOnTeam( DOTATeam_t.DOTA_TEAM_GOODGUYS );

	for( var nPlayerID = 0; nPlayerID < PlayerIDs.length; nPlayerID++ )
	{
		var HeroIcon = BonusPanel.FindChildTraverse( "BonusPlayerIcon" + nPlayerID.toString() );
		HeroIcon.heroname = Players.GetPlayerSelectedHero( nPlayerID );

		var colorInt = Players.GetPlayerColor( nPlayerID );
		var colorString = "#" + intToARGB( colorInt );

		var PlayerName = BonusPanel.FindChildTraverse( "BonusPlayerName" + nPlayerID.toString() );
		PlayerName.style.color = colorString;

		BonusPanel.SetDialogVariable( "player_name_" + nPlayerID.toString(), Players.GetPlayerName( nPlayerID ) );
		BonusPanel.SetDialogVariableInt( "bags_" + nPlayerID.toString(), 0 );
	}

	g_flBonusEndTime = data[ "end_time" ];
	BonusPanel.SetDialogVariableInt( "time_left", Math.ceil( g_flBonusEndTime - Game.GetGameTime() ) );
	BonusPanel.SetDialogVariable( "encounter_name", $.Localize( '#' + g_szEncounterName ) );
	BonusPanel.SetHasClass( "FinalGoldVisible", false );
	BonusPanel.SetDialogVariableInt( "total_gold", 0 );
	BonusPanel.SetHasClass( "Visible", true );

	g_bBonusActive = true;

	$.GetContextPanel().SetHasClass( "BonusActive", g_bBonusActive );

	UpdateBonusRound();
}

GameEvents.Subscribe( "bonus_start", OnBonusStart );

function UpdateBonusRound()
{
	var BonusPanel = $( '#BonusPanel' );
	var data = CustomNetTables.GetTableValue( "encounter_state", "bonus" );
	if ( data == null )
		return;

	var PlayerIDs = Game.GetPlayerIDsOnTeam( DOTATeam_t.DOTA_TEAM_GOODGUYS );
	for( var nPlayerID = 0; nPlayerID < PlayerIDs.length; nPlayerID++ )
	{
		var playerData = data[ nPlayerID ];
		if ( playerData == null )
			continue;

		BonusPanel.SetDialogVariableInt( "bags_" + nPlayerID.toString(), playerData[ "bags" ] );
	}

	BonusPanel.SetDialogVariableInt( "time_left", Math.ceil( g_flBonusEndTime - Game.GetGameTime() ) );

	if ( g_bBonusActive )
	{
		$.Schedule( Game.GetGameFrameTime(), UpdateBonusRound );
	}
}

function OnBonusComplete( data )
{
	$.Schedule( 10.0, FinishBonusRound );

	var nTotalGold = 0;

	var PlayerIDs = Game.GetPlayerIDsOnTeam( DOTATeam_t.DOTA_TEAM_GOODGUYS );
	for( var nPlayerID = 0; nPlayerID < PlayerIDs.length; nPlayerID++ )
	{
		var playerData = data[ nPlayerID ];
		if ( playerData == null )
			continue;

		nTotalGold = nTotalGold + playerData[ "gold" ];
	}

	$( '#BonusPanel' ).SetDialogVariableInt( "total_gold", nTotalGold );
	$( '#BonusPanel' ).SetHasClass( "FinalGoldVisible", true );

	g_bBonusActive = false;
	$.GetContextPanel().SetHasClass( "BonusActive", g_bBonusActive );

	if ( !Players.IsSpectator( Players.GetLocalPlayer() ) )
	{
		var nPlayerHeroEntIndex = Players.GetPlayerHeroEntityIndex( Players.GetLocalPlayer() );
		GameUI.SetCameraTarget( nPlayerHeroEntIndex );
		$.Schedule( Game.GetGameFrameTime(), FixCamera );
	}
}

function FinishBonusRound()
{
	var BonusPanel = $( '#BonusPanel' );
	BonusPanel.SetHasClass( "Visible", false );
	BonusPanel.SetDialogVariableInt( "total_gold", 0 );
	BonusPanel.SetHasClass( "FinalGoldVisible", false );

	var PlayerIDs = Game.GetPlayerIDsOnTeam( DOTATeam_t.DOTA_TEAM_GOODGUYS );
	for( var nPlayerID = 0; nPlayerID < PlayerIDs.length; nPlayerID++ )
	{
		BonusPanel.SetDialogVariableInt( "bags_" + nPlayerID.toString(), 0 );
	}
}

GameEvents.Subscribe( "bonus_complete", OnBonusComplete );

function OnRoomDataUpdated()
{
	var MazeMap = $( '#MazeMap' );
	for ( var nActChild = 0; nActChild < MazeMap.GetChildCount(); nActChild++ )
	{
		var ActContainer = MazeMap.GetChild( nActChild );
		if ( ActContainer == null )
			continue;

		for ( var nRoomChild = 0; nRoomChild < ActContainer.GetChildCount(); nRoomChild++ )
		{
			var RoomPanel = ActContainer.GetChild( nRoomChild );
			if ( RoomPanel == null )
				continue;

			var data = CustomNetTables.GetTableValue( "room_data", RoomPanel.id );
			if ( data == null )
				continue;

			if ( RoomPanel.GetAttributeInt( "loaded_snippet", 0 ) == 0 )
			{
				RoomPanel.BLoadLayoutSnippet( "MazeRoomSnippet" );
				RoomPanel.SetAttributeInt( "loaded_snippet", 1 );
			}

			RoomPanel.SwitchClass( "RewardClass", data[ "reward" ] );
			RoomPanel.SetHasClass( "RewardRoom", data[ "room_type" ] == 6 ) ;
			RoomPanel.SetHasClass( "BossRoom", data[ "room_type" ] == 4 ) ;
			RoomPanel.SetHasClass( "TransitionRoom", data[ "room_type" ] == 5 ) ;
			RoomPanel.SetHasClass( "Completed", data[ "completed" ] == 1 );
			RoomPanel.SetHasClass( "Current", data[ "current_room"] == 1 );

			if ( data["map_name"] != null && ( data[ "current_room" ] == 1 || data[ "completed" ] == 1 ) )
			{
				RoomPanel.AddClass( data["map_name"] );

				var szFileName = "s2r://materials/overviews/" + data[ "map_name" ] + ".vtex";
				var szStyle = "url( \"" + szFileName + "\" )";
				RoomPanel.style.backgroundImage = szStyle;
			}
			

			var szEntranceClass = "Entrance" + data["entrance_direction" ];
			RoomPanel.SwitchClass( "EntranceDirection", szEntranceClass );

			var szExitClass = "Exit" + data["exit_direction" ];
			RoomPanel.SwitchClass( "ExitDirection", szExitClass );
			if ( data[ "current_room" ] == 1 && !Players.IsSpectator( Players.GetLocalPlayer() ) )
			{
				RoomPanel.FindChildTraverse( "PlayerLocator" ).heroname = Players.GetPlayerSelectedHero( Players.GetLocalPlayer() );
			}
			RoomPanel.SetHasClass( "Elite", data[ "elite" ] > 0 );
		} 
	}
	
}

CustomNetTables.SubscribeNetTableListener( "room_data", OnRoomDataUpdated );

function OnOpenMapButtonClicked()
{
	$( '#MazeMap' ).ToggleClass( "MapOpen" );
}

OnRoomDataUpdated();

var g_bInBossCamera = false;
var g_nBossCameraEntIndex = false;
var g_flCameraDesiredOffset = 128.0;
var g_flAdditionalCameraOffset = 0.0;
var g_flMaxLookDistance = 1134.0;
var g_flCameraYawSpeed = 0.05;
var g_flInitialYaw = 0;

function OnBossIntroBegin( data )
{
	if ( g_bInBossCamera === true )
		return;

	//Game.EmitSound( "Dungeon.Stinger02" );
	//Game.EmitSound( "Dungeon.BossBar" );
	
	g_bInBossCamera = true;

	g_flInitialYaw = GameUI.GetCameraYaw();

	GameUI.SetCameraPitchMin( data["camera_pitch"] );
	GameUI.SetCameraPitchMax( data["camera_pitch"] );
	GameUI.SetCameraDistance( data["camera_distance"] );
	GameUI.SetCameraLookAtPositionHeightOffset( data["camera_height"] );
	GameUI.SetCameraTarget( data["boss_ent_index"] );
	//GameUI.SetCameraYaw( data["camera_initial_yaw"] );

	g_flCameraYawSpeed = data["camera_yaw_rotate_speed"];

}

GameEvents.Subscribe( "boss_intro_begin", OnBossIntroBegin );

function OnBossIntroEnd( data )
{
	g_bInBossCamera = false;
	g_nBossCameraEntIndex = -1;

	GameUI.SetCameraPitchMin( 38 );
	GameUI.SetCameraPitchMax( 60 );
	GameUI.SetCameraDistance( 1134.0 );
	GameUI.SetCameraLookAtPositionHeightOffset( 0 );
	GameUI.SetCameraTarget( -1 );
	GameUI.SetCameraYaw( g_flInitialYaw );

	if ( !Players.IsSpectator( Players.GetLocalPlayer() ) )
	{
		var nPlayerHeroEntIndex = Players.GetPlayerHeroEntityIndex( Players.GetLocalPlayer() );
		GameUI.SetCameraTarget( nPlayerHeroEntIndex );
		$.Schedule( Game.GetGameFrameTime(), FixCamera );

	}

	g_flCameraYawSpeed = 0.05;
}

function FixCamera()
{
	GameUI.SetCameraTarget( -1 );
}

GameEvents.Subscribe( "boss_intro_end", OnBossIntroEnd );

function OnBossFightFinished( data )
{
	//Game.EmitSound( "Dungeon.Stinger01" );
}

GameEvents.Subscribe( "boss_fight_finished", OnBossFightFinished );

var g_vWorldHintLoc = null;

GameEvents.Subscribe( "start_world_text_hint", StartWorldTextHint );
function StartWorldTextHint( event )
{
	var vAbsOrigin = [ event[ "location_x" ], event[ "location_y" ], event[ "location_z" ] ];
	var nX = Game.WorldToScreenX( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
	var nY = Game.WorldToScreenY( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );

	g_vWorldHintLoc = vAbsOrigin;

	if ( event[ "command" ] >= 0 )
	{
		$( '#WorldHintPanel' ).SetDialogVariable( "keybind", "<panel class='" + Game.GetKeybindForCommand( event["command"] ) + "'/>" );
		$( '#WorldHintPanel' ).SetDialogVariable( "secondary_keybind", "<panel class='" + GetSecondaryKeybindForCommand( event["command"] ) + "'/>" );
		$( '#WorldHintPanel' ).SetDialogVariable( "alternate_keybind", "<panel class='" + GetAlternateKeybindForCommand( event["command"] ) + "'/>" );
	}

	var szLocalizedName = $.Localize( '#' + event[ "hint_text" ], $( '#WorldHintPanel' ) );
	$( '#WorldHintPanel' ).SetDialogVariable( "world_hint_text", szLocalizedName );
	$( '#WorldHintPanel' ).style.x = ( nX / $( "#WorldHintPanel" ).actualuiscale_x ) - (  $( '#WorldHintPanel' ).actuallayoutwidth / 2 ) + "px"; 
	$( '#WorldHintPanel' ).style.y = ( nY / $( "#WorldHintPanel" ).actualuiscale_y  ) + 75 + "px";
	$( '#WorldHintPanel' ).SetHasClass( "HintVisible", true );
}

function GetSecondaryKeybindForCommand( nCommand )
{
	switch ( nCommand )
	{
		case DOTAKeybindCommand_t.DOTA_KEYBIND_HERO_ATTACK:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_HERO_MOVE:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_INVENTORYTP:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_ABILITY_PRIMARY1:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_ABILITY_PRIMARY2:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_ABILITY_PRIMARY3:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_ABILITY_SECONDARY1:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_ABILITY_SECONDARY2:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_ABILITY_ULTIMATE:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_INVENTORY1:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_INVENTORY2:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_INVENTORY3:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_INVENTORY4:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_INVENTORY5:
		case DOTAKeybindCommand_t.DOTA_KEYBIND_INVENTORY6:
			return "MOUSE1";
	}

	return Game.GetKeybindForCommand( nCommand );
}

function GetAlternateKeybindForCommand( nCommand )
{
	if ( nCommand === DOTAKeybindCommand_t.DOTA_KEYBIND_HERO_MOVE )
		return "MOUSE2";

	return Game.GetKeybindForCommand( nCommand );
}

GameEvents.Subscribe( "stop_world_text_hint", StopWorldTextHint );
function StopWorldTextHint( event )
{
	g_vWorldHintLoc = null;
	$( '#WorldHintPanel' ).SetHasClass( "HintVisible", false );
}


GameEvents.Subscribe( "begin_aghanim_victory", BeginAghanimVictory );
function BeginAghanimVictory( data )
{
	g_bInBossCamera = true;

	GameUI.MoveCameraToEntity( data[ "ent_index" ] )

	GameUI.SetCameraPitchMin( 35 );
	GameUI.SetCameraPitchMax( 35 );
	GameUI.SetCameraDistance( 800 );
	GameUI.SetCameraLookAtPositionHeightOffset( 350 );
	GameUI.SetCameraTarget( data["ent_index"] );

	var vAghanimAngles = Entities.GetAbsAngles( data[ "ent_index" ] );
	GameUI.SetCameraYaw( vAghanimAngles[ 1 ] - 10 + 90 );                                

	g_flCameraYawSpeed = 0.025;
}

(function HUDThink()
{	
	if ( g_vWorldHintLoc !== null )
	{
		var nX = Game.WorldToScreenX( g_vWorldHintLoc[0], g_vWorldHintLoc[1], g_vWorldHintLoc[2] );
		var nY = Game.WorldToScreenY( g_vWorldHintLoc[0], g_vWorldHintLoc[1], g_vWorldHintLoc[2] );
		$( '#WorldHintPanel' ).style.x = ( nX / $( "#WorldHintPanel" ).actualuiscale_x ) - (  $( '#WorldHintPanel' ).actuallayoutwidth / 2 ) + "px"; 
		$( '#WorldHintPanel' ).style.y = ( nY / $( "#WorldHintPanel" ).actualuiscale_y  ) + 75 + "px";
	}

	// if ( g_bDialogActive )
	// {
	// 	AdvanceDialog();
	// }

	if ( g_bInBossCamera )
	{
		GameUI.SetCameraYaw( GameUI.GetCameraYaw() + g_flCameraYawSpeed );
		//var vCameraLookAtPos = GameUI.GetCameraLookAtPosition();
		//GameUI.SetCameraPositionFromLateralLookAtPosition( vCameraLookAtPos[0], vCameraLookAtPos[1] );
	}

	if( g_bInCryptEncounter )
	{
		UpdateCryptGateUI( CustomNetTables.GetTableValue( "encounter_state", "crypt_gate" ) );
	}

	var HeroInteractionRowContainer = $.GetContextPanel().FindChildTraverse( "HeroInteractionRowContainer" );
	for ( var i = 0; i < HeroInteractionRowContainer.GetChildCount(); i++ )
	{
		var HeroInteractionRow = HeroInteractionRowContainer.GetChild( i );
		if ( HeroInteractionRow == null)
			continue;

		var nEntIndex = HeroInteractionRow.GetAttributeInt( "ent_index", -1 );
		if ( nEntIndex == -1 )
			continue;

		var vAbsOrigin = Entities.GetAbsOrigin( nEntIndex );
		if ( vAbsOrigin !== undefined )
	    {
			var nX = Game.WorldToScreenX( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
			var nY = Game.WorldToScreenY( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );

			HeroInteractionRow.style.x = ( nX / HeroInteractionRow.actualuiscale_x ) + "px"; 
			HeroInteractionRow.style.y = ( nY / HeroInteractionRow.actualuiscale_y ) - ( Entities.GetHealthBarOffset( nEntIndex ) * 0.8 ) + "px"; 
		}
	}


	$.Schedule( 0.003, HUDThink );
})();

(function CenterCameraForLiveSpectator()
{	
	// Center the camera on the first goodguys hero
	// NOTE: At the point at which this is called, live spectators are still on team goodguys
	// and they are later switched to team spectator.
	// So what we'll do to be reasonable is just move any player who doesn't have a player hero ent index
	var nLocalPlayerHeroEntIndex = Players.GetPlayerHeroEntityIndex( Players.GetLocalPlayer() );
	if ( nLocalPlayerHeroEntIndex > 0 && Players.GetTeam( Players.GetLocalPlayer() ) == 2 )
		return;

	var bFound = false;
	var vecPlayers = Game.GetPlayerIDsOnTeam( DOTATeam_t.DOTA_TEAM_GOODGUYS );
	if( vecPlayers != null )
	{
		for ( var szPlayerID in vecPlayers )
		{
			var nPlayerID = Number(szPlayerID);

			var playerHeroEntIndex = Players.GetPlayerHeroEntityIndex( nPlayerID );
			if ( playerHeroEntIndex > 0 )
			{
				GameUI.MoveCameraToEntity( playerHeroEntIndex )
				bFound = true;
				break;
			}
		}
	}

	if ( bFound == false )
	{
		$.Schedule( 0.003, CenterCameraForLiveSpectator );		
	}

})();

GameEvents.Subscribe( "notify_event_npc", OnNotifiedOfEventNPC );

function OnNotifiedOfEventNPC( data )
{
	$.Msg( "Notified of Event NPC" );
	var entIndex = data[ "ent_index" ];
	if ( entIndex == -1 || entIndex == 'undefined' )
		return;

	var bNotify = data[ "notify" ] == 1;
	var szPanelName = "HeroInteractionRow_" + entIndex.toString(); 

	var HeroInteractionRowPanel = $.GetContextPanel().FindChildTraverse( szPanelName );
	if ( HeroInteractionRowPanel )
	{
		var szIconPanelName = "Player" + Game.GetLocalPlayerID().toString();
		var HeroIconsRow = HeroInteractionRowPanel.FindChildTraverse( "HeroIconsRow" );
		var nHeroIconCount = HeroIconsRow != null ? HeroIconsRow.GetChildCount() : 0;
		var PlayerHeroIcon = HeroIconsRow != null ? HeroIconsRow.FindChildTraverse( szIconPanelName ) : null;
		if ( bNotify )
		{
			if ( PlayerHeroIcon != null )
				return;

			CreateHeroInteractionIcon( Game.GetLocalPlayerID(), HeroInteractionRowPanel );
		}
		else
		{
			if ( PlayerHeroIcon == null )
				return;

			PlayerHeroIcon.DeleteAsync( 0.5 );
			if ( nHeroIconCount == 1 )
			{
				//HeroIconsRow.DeleteAsync( 0.5 );
			}

		}
	}
	else
	{
		if ( !bNotify )
			return;

		HeroInteractionRowPanel = $.CreatePanel( "Panel", $.GetContextPanel().FindChildTraverse( "HeroInteractionRowContainer" ), szPanelName );
	    HeroInteractionRowPanel.BLoadLayoutSnippet( "HeroInteractionRow" );
	    HeroInteractionRowPanel.SetAttributeInt( "ent_index", entIndex );

	    var vAbsOrigin = Entities.GetAbsOrigin( entIndex );
	    if ( vAbsOrigin !== undefined )
	    {
	    	var nX = Game.WorldToScreenX( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
			var nY = Game.WorldToScreenY( vAbsOrigin[0], vAbsOrigin[1], vAbsOrigin[2] );
			HeroInteractionRowPanel.style.x = ( nX / HeroInteractionRowPanel.actualuiscale_x ) + "px"; 
			HeroInteractionRowPanel.style.y = ( nY / HeroInteractionRowPanel.actualuiscale_y ) - ( Entities.GetHealthBarOffset( entIndex ) * 0.8 ) + "px"; 
	    }
		

	    var vecPlayers = Game.GetPlayerIDsOnTeam( DOTATeam_t.DOTA_TEAM_GOODGUYS );
		if( vecPlayers != null )
		{
			for ( var szPlayerID in vecPlayers )
			{
				var nPlayerID = Number(szPlayerID);
				CreateHeroInteractionIcon( nPlayerID, HeroInteractionRowPanel );
			}
		}
	}
}

function CreateHeroInteractionIcon( nPlayerID, HeroInteractionRowPanel )
{
	var playerHeroEntIndex = Players.GetPlayerHeroEntityIndex( nPlayerID );
	if ( playerHeroEntIndex > 0 )
	{
		var HeroInteractionIcon = $.CreatePanel( "Panel", HeroInteractionRowPanel.FindChildTraverse( "HeroIconsRow" ), "Player" + nPlayerID.toString() );
		HeroInteractionIcon.BLoadLayoutSnippet( "HeroInteractionIcon" );

		var HeroIcon = HeroInteractionIcon.FindChildTraverse( "HeroInteractionIcon" );
		HeroIcon.heroname = Players.GetPlayerSelectedHero( nPlayerID );

		var HeroOutlineIcon = HeroInteractionIcon.FindChildTraverse( "HeroInteractionOutlineIcon" );

		var PlayerColor = Players.GetPlayerColor( nPlayerID );
		HeroOutlineIcon.style.washColor = "#" + intToARGB( PlayerColor );
	}
}

GameEvents.Subscribe( "interact_with_npc", OnInteractWithEventNPC );

function OnInteractWithEventNPC( data )
{
	$.Msg( "Interaction Received" );

	var EventDialogPanel = $( "#EventDialogPanel" );
	if ( EventDialogPanel == null )
	{
		$.Msg( "no event dialog panel" );
		return;
	}

	var EventOptions = data[ "event_options" ];
	if ( EventOptions == null || EventOptions == "undefined" )
	{
		$.Msg( "interaction has null event options" );
		return;
	}

	var EventOptionsContainer = EventDialogPanel.FindChildTraverse( "OptionsContainer" );
	var EventOptionsRow1 = EventDialogPanel.FindChildTraverse( "OptionsRow1" ); 
	EventOptionsRow1.RemoveAndDeleteChildren();
	var EventOptionsRow2 = EventDialogPanel.FindChildTraverse( "OptionsRow2" );
	EventOptionsRow2.RemoveAndDeleteChildren();

	$.Msg( "There are " + Object.keys(EventOptions).length + " event options" );
	var nOptionCount = 0;
	var pJoyFocusPanel = null;
	for ( var nEventOption of Object.keys( EventOptions ) )
	{
		var Option = EventOptions[ nEventOption ];
		if ( Option == null )
			continue;

		var ParentRow = nOptionCount < 6 ? EventOptionsRow1 : EventOptionsRow2;

		var OptionButton = $.CreatePanel( "Panel", ParentRow, "EventOption_" + nEventOption );
	    OptionButton.BLoadLayoutSnippet( "EventOptionButton" );

		var OptionDialogVars = Option[ "dialog_vars" ];
		if ( OptionDialogVars != null )
		{
			$.Msg( "There are " + Object.keys( OptionDialogVars ).length  + " dialog vars" );
			for ( var key of Object.keys( OptionDialogVars ) )
			{
				var DialogVar = OptionDialogVars[ key ];
				if ( DialogVar == null )
					continue;

				if ( Number.isFinite( DialogVar ) )
				{
					DialogVar = Math.floor( DialogVar ) == DialogVar ? Math.floor( DialogVar ) : DialogVar.toFixed( 2 );
				}


				$.Msg( "setting dialog var " +  key + " with " + DialogVar );
				EventDialogPanel.SetDialogVariable( key,  $.Localize( DialogVar, EventDialogPanel ) );

				//var OptionLabel = $.CreatePanel( "Label", OptionButton, "DialogVar_" + key );
				OptionButton.SetDialogVariable( key, $.Localize( DialogVar, OptionButton ) );

			}
		}

		if ( Option[ "item_name" ] != null )
		{
			OptionButton.SetHasClass( "ItemVisible", true );
			var ItemIconPanel = OptionButton.FindChildTraverse( "EventOptionItemImage" );
			if ( ItemIconPanel )
			{
				$.Msg( "setting item name " + Option[ "item_name" ] );
				ItemIconPanel.itemname = Option[ "item_name" ];
			}
		}

		if ( Option[ "ability_name" ] != null )
		{
			OptionButton.SetHasClass( "AbilityVisible", true );
			var AbilityIconPanel = OptionButton.FindChildTraverse( "EventOptionAbilityImage" );
			if ( AbilityIconPanel )
			{
				AbilityIconPanel.abilityname = Option[ "ability_name" ];
			}
		}

		if ( Option[ "image" ] != null )
		{
			OptionButton.SetHasClass( "GenericImageVisible", true );
			var ImagePanel = OptionButton.FindChildTraverse( "EventOptionGenericImage" );
			if ( ImagePanel )
			{
				var szFileName = "file://{images}/" + Option[ "image" ];
				$.Msg( szFileName );
				var szStyle = "url( \"" + szFileName + "\" )";
				ImagePanel.style.backgroundImage = szStyle;
				ImagePanel.style.backgroundPosition = "center";

				ImagePanel.SetHasClass( szFileName, true );	
			}
		}

		if ( Option[ "stock_count" ] != null )
		{
			OptionButton.SetHasClass( "StockCountVisible", Option[ "stock_count" ] > 1 );
			OptionButton.SetDialogVariable( "stock_count", Option[ "stock_count" ] )
			OptionButton.SetHasClass( "OutOfStock", Option[ "stock_count" ] == 0 );
		}

		if ( Option[ "gold_cost" ] != null )
		{
			OptionButton.SetHasClass( "GoldCostVisible", Option[ "gold_cost" ] > 0 );
			OptionButton.SetDialogVariable( "gold_cost", Option[ "gold_cost" ] )
		}

		if ( Option[ "fragment_cost" ] != null )
		{
			OptionButton.SetHasClass( "FragmentCostVisible", Option[ "fragment_cost" ] > 0 );
			OptionButton.SetDialogVariable( "fragment_cost", Option[ "fragment_cost" ] )
		}

		if ( Option[ "description"] != null )
		{
			OptionButton.SetHasClass( "DescriptionVisible", true );
			OptionButton.SetDialogVariable( "option_text", $.Localize( '#' + Option[ "description" ], OptionButton ) );
		}

		if ( Option[ "minor_shard"] != null )
		{
			OptionButton.SetHasClass( "MinorShard", true );
			OptionButton.SetHasClass( "Elite", Option[ "elite" ] == 1 );
		}

		var bOptionDismiss = Option[ "dismiss" ] == 1;
		if ( bOptionDismiss )
		{
			OptionButton.SetHasClass( "DismissIconVisible", true );
		}
		
        (function( nOptionNumber, nPlayerHeroEntIndex, nEventNPCEntIndex, bDismissDialog )
        {
            OptionButton.SetPanelEvent( 'onactivate', function () { OnEventOptionClicked( nOptionNumber, nPlayerHeroEntIndex, nEventNPCEntIndex, bDismissDialog ); } ); 
        })( nEventOption, data[ "interact_player_hero_ent_index" ], data[ "interact_npc_ent_index" ], bOptionDismiss );
		if ( pJoyFocusPanel === null )
			pJoyFocusPanel = OptionButton;
        nOptionCount++;
	}

	for ( var nCurrOptionChild = 0; nCurrOptionChild < EventOptionsRow1.GetChildCount(); nCurrOptionChild++ )
	{
		var OptionChild = EventOptionsRow1.GetChild( nCurrOptionChild );
		if ( OptionChild == null )
			continue;

		if ( OptionChild.BHasClass( "DismissIconVisible" ) )
		{
			for ( var nBeforeOptionChild = 0; nBeforeOptionChild < EventOptionsRow1.GetChildCount(); nBeforeOptionChild++ )
			{
				var BeforeOptionChild = EventOptionsRow1.GetChild( nBeforeOptionChild );
				if ( BeforeOptionChild == null )
					continue;

				if ( BeforeOptionChild != OptionChild )
				{
					$.Msg( "moving child" );
					EventOptionsRow1.MoveChildAfter( OptionChild, BeforeOptionChild );
				}
			}
			break;
		}

	}

	
	var nInteractEntIndex = data[ "interact_npc_ent_index" ];
	var szUnitName = Entities.GetUnitName( nInteractEntIndex );
	var szLocalizeString = data[ "event_description" ] != null ? data[ "event_description" ] : szUnitName + "_event_body_description";

	EventDialogPanel.SetDialogVariable( "event_body_description", $.Localize( '#' + szLocalizeString, EventDialogPanel ) );
	EventDialogPanel.SetHasClass( "EventDialogActive", true );
	//EventDialogPanel.SetHasClass( "EventRoomStore", data[ "interaction_limit" ] == -1 );
	EventDialogPanel.SetAttributeInt( "store_room", data[ "interaction_limit" ] == -1 ? 1 : 0 );
	EventDialogPanel.SetAttributeInt( "interaction_limit", data[ "interaction_limit" ] );
	EventDialogPanel.SetAttributeInt( "interact_npc_ent_index", nInteractEntIndex );
	EventDialogPanel.SetDialogVariable( "event_npc_name",  GameUI.GetUnitNameLocalized( szUnitName ) );
	$( "#EventNPCScenePanel" ).SetUnit( szUnitName, "default_camera", true );	
	if ( pJoyFocusPanel !== null )
		Game.SetJoyFocusPanel( pJoyFocusPanel );
}

function OnEventOptionClicked( nOptionNumber, nPlayerHeroEntIndex, nEventNPCEntIndex, bDismissDialog )
{
	$.Msg( "option " + nOptionNumber + " chosen" );
	$.Msg( "dismiss:" + bDismissDialog );
	var EventDialogPanel = $( "#EventDialogPanel" );

	var nInteractionsRemaining = EventDialogPanel.GetAttributeInt( "interaction_limit", 1 );
	var bStoreRoom = EventDialogPanel.GetAttributeInt( "store_room", 0 ) == 1;
	if ( bStoreRoom )
	{
		nInteractionsRemaining = 99999;
	}
	else
	{
		nInteractionsRemaining = nInteractionsRemaining - 1;
		EventDialogPanel.SetAttributeInt( "interaction_limit", nInteractionsRemaining );	
	}

	var bChoicesLeft = nInteractionsRemaining > 0 && !bDismissDialog;
	EventDialogPanel.SetHasClass( "EventDialogActive", bChoicesLeft );

	var data = {}
    data[ "player_id" ] = Players.GetLocalPlayer();
    data[ "interact_npc_ent_index" ] = nEventNPCEntIndex;
    data[ "interact_option_response" ] = nOptionNumber;
    GameEvents.SendCustomGameEventToServer( "interact_with_npc_response", data );
	Game.PopJoyFocusPanel();
}


GameEvents.Subscribe( "interact_with_npc_response_result", OnInteractWithEventNPCResponseResult );
function OnInteractWithEventNPCResponseResult( data )
{
	$.Msg( "Interaction Response Result Received" );
	$.Msg( data[ "result_code"] );

	var szErrorText = null;
	var szErrorSound = null;
	switch( data["result_code" ] )
	{
		case 0:
		case 6:
		default:
			return;

		
		case 2:
			szErrorText = "#dota_hud_error_item_out_of_stock";
			szErrorSound = "General.Item_OutOfStock";
			break;
			
		case 1:
		case 3:
			szErrorText =  "#dota_hud_error_cant_target_shop";
			szErrorSound = "General.InvalidTarget_Shop";
			break;
		case 4:
			szErrorText = "#dota_hud_error_not_enough_gold";
			szErrorSound = "General.NoGold";
			break;
		case 5:
			szErrorText = "#dota_hud_error_not_enough_fragments";
			szErrorSound = "General.NoGold";
			break;

	}

	if ( szErrorText && szErrorSound )
	{
		GameUI.SendCustomHUDError( szErrorText, szErrorSound );
	}
}


GameEvents.Subscribe( "update_event_stock_count", OnEventStockUpdated );
function OnEventStockUpdated( data )
{
	$.Msg( "Interaction Response Result Received" );
	var EventDialogPanel = $( "#EventDialogPanel" );
	if ( !EventDialogPanel.BHasClass( "EventDialogActive" ) )
		return;

	var nInteractEntIndex = data[ "interact_npc_ent_index" ];
	var nCurrentInteractEntIndex = EventDialogPanel.GetAttributeInt( "interact_npc_ent_index", -1 );
	if ( nInteractEntIndex != nCurrentInteractEntIndex )
		return;

	$.Msg( "need to update stock counts!" );

	var nOptionNumber = data[ "option" ]
	var OptionButton = EventDialogPanel.FindChildTraverse( "EventOption_" + nOptionNumber );
	if ( OptionButton )
	{
		OptionButton.SetHasClass( "StockCountVisible", data[ "stock_count" ] > 0 );
		OptionButton.SetDialogVariable( "stock_count", data[ "stock_count" ] )
		OptionButton.SetHasClass( "OutOfStock", data[ "stock_count" ] == 0 );
	}
} 

GameEvents.Subscribe( "begin_primal_beast_victory", BeginPrimalBeastVictory );
function BeginPrimalBeastVictory( data )
{
	var hudPanel = $.GetContextPanel().FindAncestor( "CustomUIRoot" );
	if ( hudPanel )
	{
		hudPanel.AddClass( "AghanimEndGameCinematic" );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_ACTION_PANEL, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_INVENTORY_PANEL, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_INVENTORY_SHOP, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_INVENTORY_ITEMS, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_INVENTORY_QUICKBUY, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_INVENTORY_COURIER, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_INVENTORY_PROTECT, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_INVENTORY_GOLD, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_SHOP_SUGGESTEDITEMS, false );
		GameUI.SetDefaultUIEnabled( DotaDefaultUIElement_t.DOTA_DEFAULT_UI_SHOP_COMMONITEMS, false );
	}
}

GameEvents.Subscribe( "pan_camera_to_beast", PanCameraToBeast );
function PanCameraToBeast( data )
{
	g_bInBossCamera = true;

	GameUI.MoveCameraToEntity( data[ "ent_index" ] )

	GameUI.SetCameraPitchMin( 30 );
	GameUI.SetCameraPitchMax( 30 );
	GameUI.SetCameraDistance( 850 );
	GameUI.SetCameraLookAtPositionHeightOffset( 250 );
	GameUI.SetCameraTarget( data["ent_index"] );
	GameUI.SetCameraYaw( 30 );                         

	g_flCameraYawSpeed = 0;
}

GameEvents.Subscribe( "unlock_camera_from_beast", UnlockCameraFromBeast );
function UnlockCameraFromBeast( data )
{
	GameUI.SetCameraTarget( -1 );
}

GameEvents.Subscribe( "begin_aghanim_clone_scene", BeginAghanimCloneScene );
function BeginAghanimCloneScene( data )
{
	g_bInBossCamera = true;

	GameUI.MoveCameraToEntity( data[ "ent_index" ] )

	GameUI.SetCameraPitchMin( 15 );
	GameUI.SetCameraPitchMax( 15 );
	GameUI.SetCameraDistance( 925 );
	GameUI.SetCameraLookAtPositionHeightOffset( 150 );
	GameUI.SetCameraTarget( data["ent_index"] );
	GameUI.SetCameraYaw( 75 );  

	g_flCameraYawSpeed = 0.005;
}

GameEvents.Subscribe( "begin_aghanim_outro_scene", BeginAghanimOutroScene );
function BeginAghanimOutroScene( data )
{
	g_bInBossCamera = true;
	//GameUI.SetCameraYaw( 75 ); 
	//GameUI.MoveCameraToEntity( data[ "ent_index" ] )

	//GameUI.SetCameraPitchMin( 25 );
	//GameUI.SetCameraPitchMax( 25 );
	//GameUI.SetCameraDistance( 650 );
	//GameUI.SetCameraLookAtPositionHeightOffset( 250 );
	//GameUI.SetCameraTarget( data["ent_index"] );
	//GameUI.SetCameraYaw( 45 );  

	g_flCameraYawSpeed = 0.005;
}



